<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consulta Integrada - Debug</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- Incluir as classes de valida√ß√£o -->
    <script>
        // Conte√∫do do refs/cpf.js
        class CPFValidator {
            static CPF_LENGTH = 11;
            static BASE_LENGTH = 9;
            static REGEX_NON_DIGITS = /[^\d]/g;
            static REGEX_ALL_REPEATING = /^(\d)\1{10}$/;
            static WEIGHTS_DV1 = [10, 9, 8, 7, 6, 5, 4, 3, 2];
            static WEIGHTS_DV2 = [11, 10, 9, 8, 7, 6, 5, 4, 3, 2];

            static isValid(cpf) {
              if (!cpf || typeof cpf !== 'string') return false;
              const cleanedCpf = this._clean(cpf);

              if (cleanedCpf.length !== this.CPF_LENGTH) return false;

              if (this.REGEX_ALL_REPEATING.test(cleanedCpf)) return false;

              const base = cleanedCpf.substring(0, this.BASE_LENGTH);
              const providedDvs = cleanedCpf.substring(this.BASE_LENGTH, this.CPF_LENGTH);

              const calculatedDvs = this._calculateCheckDigits(base);

              return providedDvs === calculatedDvs;
            }

            static _clean(cpf) {
              return cpf.replace(this.REGEX_NON_DIGITS, "");
            }

            static _calculateCheckDigits(base) {
              const baseNumbers = base.split('').map(Number);

              const dv1 = this._calculateDigit(baseNumbers, this.WEIGHTS_DV1);
              const dv2 = this._calculateDigit([...baseNumbers, dv1], this.WEIGHTS_DV2);

              return `${dv1}${dv2}`;
            }

            static _calculateDigit(numbers, weights) {
              const sum = numbers.reduce((acc, number, index) => {
                return acc + (number * weights[index]);
              }, 0);

              const rest = sum % 11;
              return rest < 2 ? 0 : 11 - rest;
            }
        }

        // Conte√∫do do refs/cnpj.js
        class CNPJValidator {
            static tamanhoCNPJSemDV = 12;
            static regexCNPJSemDV = /^([A-Z\d]){12}$/;
            static regexCNPJ = /^([A-Z\d]){12}(\d){2}$/;
            static regexCaracteresMascara = /[./-]/g;
            static regexCaracteresNaoPermitidos = /[^A-Z\d./-]/i;
            static valorBase = "0".charCodeAt(0);
            static pesosDV = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            static cnpjZerado = "00000000000000";

            static isValid(cnpj) {
                if (!this.regexCaracteresNaoPermitidos.test(cnpj)) {
                    let cnpjSemMascara = this.removeMascaraCNPJ(cnpj);
                    if (this.regexCNPJ.test(cnpjSemMascara) && cnpjSemMascara !== this.cnpjZerado) {
                        const dvInformado = cnpjSemMascara.substring(this.tamanhoCNPJSemDV);
                        const dvCalculado = this.calculaDV(cnpjSemMascara.substring(0, this.tamanhoCNPJSemDV));
                        return dvInformado === dvCalculado;
                    }
                }
                return false;
            }

            static calculaDV(cnpj) {
                if (!this.regexCaracteresNaoPermitidos.test(cnpj)) {
                    let cnpjSemMascara = this.removeMascaraCNPJ(cnpj);
                    if (this.regexCNPJSemDV.test(cnpjSemMascara) && cnpjSemMascara !== this.cnpjZerado.substring(0, this.tamanhoCNPJSemDV)) {
                        let somatorioDV1 = 0;
                        let somatorioDV2 = 0;
                        for (let i = 0; i < this.tamanhoCNPJSemDV; i++) {
                            const asciiDigito = cnpjSemMascara.charCodeAt(i) - this.valorBase;
                            somatorioDV1 += asciiDigito * this.pesosDV[i + 1];
                            somatorioDV2 += asciiDigito * this.pesosDV[i];
                        }
                        const dv1 = somatorioDV1 % 11 < 2 ? 0 : 11 - (somatorioDV1 % 11);
                        somatorioDV2 += dv1 * this.pesosDV[this.tamanhoCNPJSemDV];
                        const dv2 = somatorioDV2 % 11 < 2 ? 0 : 11 - (somatorioDV2 % 11);
                        return `${dv1}${dv2}`;
                    }
                }
                throw new Error("N√£o √© poss√≠vel calcular o DV pois o CNPJ fornecido √© inv√°lido");
            }

            static removeMascaraCNPJ(cnpj) {
                return cnpj.replace(this.regexCaracteresMascara, "");
            }
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tabs {
            margin-bottom: 20px;
        }
        .tab-button {
            background: #e0e0e0;
            border: none;
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .tab-button.active {
            background: #007bff;
            color: white;
        }
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .search-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .json-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        .people-list {
            margin: 20px 0;
        }
        .person-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .person-item:hover {
            background: #e9ecef;
        }
        .endpoint-info {
            margin: 10px 0;
            padding: 10px;
            background: #e7f3ff;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>Sistema de Consulta Integrada - Debug Mode</h1>
            <p>Vers√£o simplificada para validar o backend e visualizar JSON bruto</p>
            
            <div class="search-section">
                <h2>Buscar Dados</h2>
                
                <div class="tabs">
                    <button 
                        class="tab-button" 
                        :class="{ active: searchType === 'person' }"
                        @click="searchType = 'person'"
                    >
                        Buscar Pessoa (CPF/Nome)
                    </button>
                    <button 
                        class="tab-button" 
                        :class="{ active: searchType === 'company' }"
                        @click="searchType = 'company'"
                    >
                        Buscar Empresa (CNPJ)
                    </button>
                </div>
                
                <div class="search-form">
                    <input 
                        v-model="searchQuery" 
                        :placeholder="searchType === 'person' ? 'Digite CPF (ex: 12345678901) ou Nome' : 'Digite CNPJ (ex: 12345678000195)'"
                        class="search-input"
                        @keyup.enter="search"
                    />
                    <button 
                        @click="search" 
                        :disabled="loading || !searchQuery.trim()"
                        class="search-button"
                    >
                        {{ loading ? 'Buscando...' : 'Buscar' }}
                    </button>
                </div>
                
                <div v-if="lastEndpoint" class="endpoint-info">
                    <strong>√öltimo endpoint chamado:</strong> {{ lastEndpoint }}
                </div>
            </div>
            
            <!-- Status Messages -->
            <div v-if="loading" class="status loading">
                üîÑ Carregando dados...
            </div>
            
            <div v-if="error" class="status error">
                ‚ùå {{ error }}
            </div>
            
            <div v-if="success" class="status success">
                ‚úÖ {{ success }}
            </div>
            
            <!-- Lista de pessoas (quando busca por nome retorna m√∫ltiplas pessoas) -->
            <div v-if="results && results.type === 'people_list'" class="people-list">
                <h2>Pessoas Encontradas ({{ results.people.length }})</h2>
                <p>Clique em uma pessoa para ver suas empresas:</p>
                <div 
                    v-for="person in results.people" 
                    :key="person.cpf"
                    class="person-item"
                    @click="selectPerson(person.cpf)"
                >
                    <strong>{{ person.nome }}</strong><br>
                    <small>CPF: {{ person.cpf }}</small>
                </div>
            </div>
            
            <!-- JSON Output -->
            <div v-if="jsonOutput" class="json-output">
                <h3>JSON Retornado:</h3>
                {{ jsonOutput }}
            </div>
            
            <!-- Raw Request/Response Info -->
            <div v-if="requestInfo" class="json-output">
                <h3>Informa√ß√µes da Requisi√ß√£o:</h3>
                {{ requestInfo }}
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    searchType: 'person',
                    searchQuery: '',
                    loading: false,
                    error: null,
                    success: null,
                    results: null,
                    jsonOutput: null,
                    requestInfo: null,
                    lastEndpoint: null
                };
            },
            methods: {
                clearMessages() {
                    this.error = null;
                    this.success = null;
                    this.jsonOutput = null;
                    this.requestInfo = null;
                },
                
                async search() {
                    if (!this.searchQuery.trim()) return;

                    this.loading = true;
                    this.clearMessages();
                    this.results = null;

                    try {
                        let response;
                        let endpoint;
                        let requestData;

                        if (this.searchType === 'person') {
                            endpoint = 'http://localhost:5000/api/search_person';
                            requestData = { query: this.searchQuery };

                            // Valida√ß√£o CPF se a query parece ser um CPF
                            const cleanQuery = this.searchQuery.replace(/\D/g, '');
                            if (cleanQuery.length === 11) {
                                if (!CPFValidator.isValid(this.searchQuery)) {
                                    this.error = 'CPF inv√°lido';
                                    this.loading = false;
                                    return;
                                }
                            }

                        } else {
                            endpoint = 'http://localhost:5000/api/search_company';
                            requestData = { cnpj: this.searchQuery };

                            // Valida√ß√£o CNPJ
                            if (!CNPJValidator.isValid(this.searchQuery)) {
                                this.error = 'CNPJ inv√°lido';
                                this.loading = false;
                                return;
                            }
                        }
                        
                        this.lastEndpoint = endpoint;
                        
                        // Fazer a requisi√ß√£o
                        response = await axios.post(endpoint, requestData);
                        
                        // Mostrar informa√ß√µes da requisi√ß√£o
                        this.requestInfo = JSON.stringify({
                            url: endpoint,
                            method: 'POST',
                            requestData: requestData,
                            status: response.status,
                            statusText: response.statusText
                        }, null, 2);
                        
                        // Mostrar JSON bruto
                        this.jsonOutput = JSON.stringify(response.data, null, 2);
                        
                        // Armazenar resultados
                        this.results = response.data;

                        // Mensagem de sucesso baseada no tipo
                        if (response.data.type === 'people_list') {
                            this.success = `Dados carregados com sucesso! Encontradas ${response.data.people.length} pessoa(s)`;
                        } else if (response.data.type === 'company_data') {
                            this.success = `Dados carregados com sucesso! Empresa encontrada com ${response.data.data.partners.length} s√≥cio(s)`;
                        } else if (response.data.type === 'company_not_found') {
                            this.success = `Busca realizada com sucesso! ${response.data.message}`;
                        } else {
                            this.success = `Dados carregados com sucesso! Tipo: ${response.data.type}`;
                        }
                        
                    } catch (err) {
                        this.error = err.response?.data?.error || `Erro ao buscar dados: ${err.message}`;
                        
                        // Mostrar informa√ß√µes do erro
                        this.requestInfo = JSON.stringify({
                            url: this.lastEndpoint,
                            method: 'POST',
                            requestData: this.searchType === 'person' ? { query: this.searchQuery } : { cnpj: this.searchQuery },
                            error: err.response?.data || err.message,
                            status: err.response?.status || 'Network Error'
                        }, null, 2);
                        
                    } finally {
                        this.loading = false;
                    }
                },
                

                async selectPerson(cpf) {
                    this.loading = true;
                    this.clearMessages();

                    // Valida√ß√£o CPF
                    if (!CPFValidator.isValid(cpf)) {
                        this.error = 'CPF inv√°lido';
                        this.loading = false;
                        return;
                    }

                    try {
                        const endpoint = 'http://localhost:5000/api/person_companies';
                        const requestData = { cpf: cpf };

                        this.lastEndpoint = endpoint;

                        const response = await axios.post(endpoint, requestData);

                        // Mostrar informa√ß√µes da requisi√ß√£o
                        this.requestInfo = JSON.stringify({
                            url: endpoint,
                            method: 'POST',
                            requestData: requestData,
                            status: response.status,
                            statusText: response.statusText
                        }, null, 2);

                        // Mostrar JSON bruto
                        this.jsonOutput = JSON.stringify(response.data, null, 2);

                        this.success = `Dados da pessoa e empresas carregados com sucesso!`;

                    } catch (err) {
                        this.error = err.response?.data?.error || `Erro ao buscar dados da pessoa: ${err.message}`;

                        this.requestInfo = JSON.stringify({
                            url: 'http://localhost:5000/api/person_companies',
                            method: 'POST',
                            requestData: { cpf: cpf },
                            error: err.response?.data || err.message,
                            status: err.response?.status || 'Network Error'
                        }, null, 2);

                    } finally {
                        this.loading = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>